<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - Admin Rocket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script>tailwind.config = { theme: { extend: { colors: { accent: '#ca000d' } } } }</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif
        }

        [x-cloak] {
            display: none !important
        }

        .htmx-indicator {
            display: none
        }

        .htmx-request .htmx-indicator {
            display: inline-block
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, .1);
            border-top-color: #ca000d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin .8s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
    </style>
</head>

<body class="bg-zinc-950 text-zinc-100 min-h-screen" hx-ext="morph">

    <div x-data="{
        stats:{total:0,page:0,perPage:0},
        modal:{open:false,data:null},
        notifications:[],
        searchTerm:'',
        allRows:[],
        init(){
            document.body.addEventListener('htmx:afterSwap',e=>{
                if(e.detail.target.id==='table-content'||e.detail.target.id==='stats-container'){
                    try{
                        const d=JSON.parse(e.detail.xhr.response);
                        this.stats={total:d.total||0,page:d.page||0,perPage:d.per_page||0};
                    }catch(err){}
                    this.allRows=Array.from(document.querySelectorAll('#schedule-table tbody tr'));
                }
            });
            document.body.addEventListener('htmx:responseError',e=>{
                if(e.detail.xhr.status===403){
                    this.notify('Acesso negado','error');
                    setTimeout(()=>window.location.href='/',2e3);
                }else this.notify('Erro ao carregar dados','error');
            });
        },
        filterTable(){
            const t=this.searchTerm.toLowerCase();
            this.allRows.forEach(r=>r.style.display=!t||r.textContent.toLowerCase().includes(t)?'':'none');
        },
        viewDetails(d){this.modal={open:true,data:d}},
        async deleteSchedule(id){
            if(!confirm('Excluir agendamento?'))return;
            try{
                const r=await fetch(`/api/support/schedule?id=${id}`,{method:'DELETE',credentials:'include',headers:{'Accept':'application/json'}});
                if(!r.ok)throw new Error('Erro');
                this.notify('Exclu√≠do com sucesso','success');
                htmx.trigger('#table-content','refresh');
            }catch(e){this.notify('Erro ao excluir','error')}
        },
        formatDate(d){return new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})},
        formatDateFull(d){return new Date(d).toLocaleString('pt-BR',{dateStyle:'full',timeStyle:'short'})},
        notify(msg,type){
            const id=Date.now(),n={id,message:msg,type,visible:true};
            this.notifications.push(n);
            setTimeout(()=>{
                const i=this.notifications.findIndex(x=>x.id===id);
                if(i!==-1){this.notifications[i].visible=false;setTimeout(()=>this.notifications=this.notifications.filter(x=>x.id!==id),300)}
            },3500);
        }
    }">

        <!-- Header -->
        <header class="bg-zinc-900 border-b border-zinc-800 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-accent rounded-lg flex items-center justify-center text-2xl">üöÄ</div>
                        <div>
                            <h1 class="text-xl font-semibold">Agendamentos</h1>
                            <p class="text-xs text-zinc-500">Painel Administrativo</p>
                        </div>
                    </div>
                    <button @click="window.location.href='/'"
                        class="px-4 py-2 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-lg transition">‚Üê Voltar</button>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" id="stats-container"
                hx-get="/api/support/schedule?page=1&per_page=20" hx-trigger="load,statsRefresh from:body"
                hx-target="this" hx-swap="none">
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
                    <p class="text-xs text-zinc-500 uppercase font-medium mb-2">Total</p>
                    <p class="text-3xl font-bold text-accent" x-text="stats.total">-</p>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
                    <p class="text-xs text-zinc-500 uppercase font-medium mb-2">P√°gina</p>
                    <p class="text-3xl font-bold" x-text="stats.page">-</p>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
                    <p class="text-xs text-zinc-500 uppercase font-medium mb-2">Por P√°gina</p>
                    <p class="text-3xl font-bold" x-text="stats.perPage">-</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" x-model="searchTerm" @input.debounce.300ms="filterTable()" placeholder="üîç Buscar..."
                    class="flex-1 px-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg placeholder-zinc-500 focus:outline-none focus:border-accent transition">
                <button hx-get="/api/support/schedule?page=1&per_page=20" hx-target="#table-content"
                    hx-indicator="#refresh-spinner"
                    class="px-6 py-3 bg-accent hover:bg-[#a0000a] text-white font-medium rounded-lg transition whitespace-nowrap flex items-center gap-2">
                    <span id="refresh-spinner" class="htmx-indicator spinner w-4 h-4"></span>üîÑ Atualizar
                </button>
            </div>

            <!-- Table -->
            <div id="table-content" hx-get="/api/support/schedule?page=1&per_page=20" hx-trigger="load"
                hx-swap="innerHTML"
                class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden min-h-[400px] flex items-center justify-center">
                <div class="text-center p-12">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-zinc-500">Carregando...</p>
                </div>
            </div>

        </main>

        <!-- Modal -->
        <div x-show="modal.open" x-cloak @click.self="modal.open=false" @keydown.escape.window="modal.open=false"
            class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">
                <div
                    class="sticky top-0 bg-zinc-900 border-b border-zinc-800 px-6 py-4 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-accent">Detalhes</h2>
                    <button @click="modal.open=false"
                        class="w-8 h-8 rounded-lg hover:bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-zinc-100 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="px-6 py-6 space-y-6">
                    <template x-if="modal.data">
                        <div class="space-y-4">
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-1">ID</label>
                                <p class="text-accent font-semibold" x-text="'#'+modal.data.id"></p>
                            </div>
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-1">Nome</label>
                                <p x-text="modal.data.name"></p>
                            </div>
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-1">Empresa</label>
                                <p x-text="modal.data.enterprise_name"></p>
                            </div>
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-1">Email</label><a
                                    :href="'mailto:'+modal.data.email" class="text-accent hover:underline"
                                    x-text="modal.data.email"></a></div>
                            <div><label
                                    class="block text-xs text-zinc-500 uppercase font-medium mb-1">Telefone</label><a
                                    :href="'tel:'+modal.data.phone" class="text-accent hover:underline"
                                    x-text="modal.data.phone"></a></div>
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-1">Data</label>
                                <p class="text-zinc-400" x-text="formatDateFull(modal.data.created_at)"></p>
                            </div>
                            <div><label class="block text-xs text-zinc-500 uppercase font-medium mb-2">Mensagem</label>
                                <div class="bg-zinc-950 border border-zinc-800 rounded-lg p-4 text-zinc-300 leading-relaxed"
                                    x-text="modal.data.comment"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="fixed top-4 right-4 z-50 space-y-2">
            <template x-for="n in notifications" :key="n.id">
                <div x-show="n.visible" x-transition:enter="transition ease-out duration-300 transform"
                    x-transition:enter-start="translate-x-full opacity-0"
                    x-transition:enter-end="translate-x-0 opacity-100"
                    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
                    x-transition:leave-end="opacity-0"
                    :class="n.type==='success'?'bg-green-900 border-green-700 text-green-100':'bg-red-900 border-red-700 text-red-100'"
                    class="border px-4 py-3 rounded-lg shadow-lg max-w-sm" x-text="n.message"></div>
            </template>
        </div>

    </div>

    <script>
        document.body.addEventListener('htmx:beforeSwap', function (evt) { if (evt.detail.target.id === 'table-content') { try { const d = JSON.parse(evt.detail.xhr.response); if (d.items && d.items.length === 0) { evt.detail.serverResponse = '<div class="text-center p-12"><div class="w-20 h-20 mx-auto mb-4 bg-zinc-800 rounded-full flex items-center justify-center"><svg class="w-10 h-10 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div><h3 class="text-lg font-semibold text-zinc-300 mb-2">Nenhum agendamento</h3><p class="text-zinc-500">Ainda n√£o h√° solicita√ß√µes.</p></div>'; return } const rows = d.items.map(i => { const dt = new Date(i.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }); const e = t => document.createElement('div').appendChild(document.createTextNode(t)).parentNode.innerHTML; return `<tr class="hover:bg-accent/5 transition"><td class="px-4 py-4"><span class="inline-flex items-center px-2 py-1 bg-accent/10 text-accent text-xs font-semibold rounded">#${i.id}</span></td><td class="px-4 py-4"><div class="font-medium">${e(i.name)}</div><div class="text-sm text-zinc-500 md:hidden">${e(i.enterprise_name)}</div></td><td class="px-4 py-4 hidden md:table-cell text-zinc-300">${e(i.enterprise_name)}</td><td class="px-4 py-4 hidden lg:table-cell text-zinc-400 text-sm">${e(i.email)}</td><td class="px-4 py-4 hidden xl:table-cell text-zinc-400 text-sm">${e(i.phone)}</td><td class="px-4 py-4 hidden lg:table-cell text-zinc-500 text-sm">${dt}</td><td class="px-4 py-4 text-right"><div class="flex items-center justify-end gap-2"><button @click="viewDetails(${JSON.stringify(i).replace(/"/g, '&quot;')})" class="px-3 py-1.5 text-sm bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition">Ver</button><button @click="deleteSchedule(${i.id})" class="px-3 py-1.5 text-sm bg-red-900/20 hover:bg-red-900/30 text-red-400 rounded-lg transition">Excluir</button></div></td></tr>` }).join(''); const pg = (c, t) => { let h = `<button hx-get="/api/support/schedule?page=${c - 1}&per_page=20" hx-target="#table-content" ${c === 1 ? 'disabled' : ''} class="px-4 py-2 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-lg transition ${c === 1 ? 'opacity-50 cursor-not-allowed' : ''}">‚Üê</button>`; for (let i = 1; i <= t; i++) { if (i === 1 || i === t || (i >= c - 1 && i <= c + 1)) { h += `<button hx-get="/api/support/schedule?page=${i}&per_page=20" hx-target="#table-content" class="px-4 py-2 text-sm rounded-lg transition ${i === c ? 'bg-accent text-white' : 'bg-zinc-800 hover:bg-zinc-700 text-zinc-300'}">${i}</button>` } else if (i === c - 2 || i === c + 2) h += '<span class="px-2 text-zinc-600">...</span>' } h += `<button hx-get="/api/support/schedule?page=${c + 1}&per_page=20" hx-target="#table-content" ${c === t ? 'disabled' : ''} class="px-4 py-2 text-sm bg-zinc-800 hover:bg-zinc-700 rounded-lg transition ${c === t ? 'opacity-50 cursor-not-allowed' : ''}">‚Üí</button>`; return h }; evt.detail.serverResponse = `<div class="overflow-x-auto"><table id="schedule-table" class="w-full"><thead class="bg-zinc-800 border-b border-zinc-700"><tr><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase">ID</th><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase">Nome</th><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase hidden md:table-cell">Empresa</th><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase hidden lg:table-cell">Email</th><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase hidden xl:table-cell">Telefone</th><th class="px-4 py-3 text-left text-xs font-semibold text-zinc-400 uppercase hidden lg:table-cell">Data</th><th class="px-4 py-3 text-right text-xs font-semibold text-zinc-400 uppercase">A√ß√µes</th></tr></thead><tbody class="divide-y divide-zinc-800">${rows}</tbody></table></div>${d.total_pages > 1 ? `<div class="flex items-center justify-center gap-2 mt-6">${pg(d.page, d.total_pages)}</div>` : ''}` } catch (e) { console.error('Error:', e) } } });
    </script>
</body>

</html>